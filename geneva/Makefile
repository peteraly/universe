# GolfVision Makefile

.PHONY: help up down build clean test demo install dev logs status

# Default target
help:
	@echo "GolfVision - Golf Course Video Generator"
	@echo ""
	@echo "Available commands:"
	@echo "  make up          - Start all services with Docker Compose"
	@echo "  make down        - Stop all services"
	@echo "  make build       - Build all Docker images"
	@echo "  make clean       - Clean up containers, images, and volumes"
	@echo "  make install     - Install dependencies for local development"
	@echo "  make dev         - Start development environment"
	@echo "  make test        - Run all tests"
	@echo "  make demo        - Run a demo job"
	@echo "  make logs        - Show logs from all services"
	@echo "  make status      - Show status of all services"
	@echo "  make reset       - Reset everything and start fresh"

# Docker commands
up:
	@echo "ðŸš€ Starting GolfVision services..."
	docker-compose up -d
	@echo "âœ… Services started! Dashboard: http://localhost:3000"

down:
	@echo "ðŸ›‘ Stopping GolfVision services..."
	docker-compose down
	@echo "âœ… Services stopped"

build:
	@echo "ðŸ”¨ Building Docker images..."
	docker-compose build --no-cache
	@echo "âœ… Images built successfully"

clean:
	@echo "ðŸ§¹ Cleaning up Docker resources..."
	docker-compose down -v --remove-orphans
	docker system prune -f
	docker volume prune -f
	@echo "âœ… Cleanup complete"

logs:
	@echo "ðŸ“‹ Showing logs from all services..."
	docker-compose logs -f

status:
	@echo "ðŸ“Š Service Status:"
	@docker-compose ps
	@echo ""
	@echo "ðŸ” Health Checks:"
	@curl -s http://localhost:4000/health || echo "Server not responding"
	@curl -s http://localhost:3000 | head -1 || echo "Web not responding"

reset: clean build up
	@echo "ðŸ”„ System reset complete!"

# Development commands
install:
	@echo "ðŸ“¦ Installing dependencies..."
	pnpm install
	@echo "âœ… Dependencies installed"

dev:
	@echo "ðŸ› ï¸  Starting development environment..."
	pnpm dev

# Testing commands
test:
	@echo "ðŸ§ª Running tests..."
	pnpm test

test:unit:
	@echo "ðŸ§ª Running unit tests..."
	pnpm test:unit

test:e2e:
	@echo "ðŸ§ª Running end-to-end tests..."
	pnpm test:e2e

test:golden:
	@echo "ðŸ§ª Running golden tests..."
	pnpm test:golden

# Error monitoring commands
monitor:errors:
	@echo "ðŸ” Running error monitor..."
	node scripts/error-monitor.js

monitor:health:
	@echo "ðŸ¥ Checking system health..."
	@curl -s http://localhost:4000/health | jq . || echo "Server not responding"
	@curl -s http://localhost:3000 | head -1 || echo "Web not responding"

# Demo commands
demo:
	@echo "ðŸŽ¬ Running demo job..."
	curl -X POST http://localhost:4000/api/jobs \
		-H "Content-Type: application/json" \
		-d '{"courseName": "Pebble Beach", "seed": 12345}'

# Utility commands
open:
	@echo "ðŸŒ Opening dashboard..."
	open http://localhost:3000

health:
	@echo "ðŸ¥ Health check..."
	@curl -s http://localhost:4000/health | jq .

jobs:
	@echo "ðŸ“‹ Current jobs..."
	@curl -s http://localhost:4000/api/jobs | jq .

# Production commands
prod:
	@echo "ðŸš€ Starting production environment..."
	docker-compose --profile production up -d

prod:logs:
	@echo "ðŸ“‹ Production logs..."
	docker-compose --profile production logs -f

# Backup and restore
backup:
	@echo "ðŸ’¾ Creating backup..."
	mkdir -p backups
	tar -czf backups/golfvision-$(shell date +%Y%m%d-%H%M%S).tar.gz \
		--exclude=node_modules \
		--exclude=.git \
		--exclude=backups \
		.

restore:
	@echo "ðŸ“¥ Restoring from backup..."
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "Usage: make restore BACKUP_FILE=backups/filename.tar.gz"; \
		exit 1; \
	fi
	tar -xzf $(BACKUP_FILE)

# Monitoring
monitor:
	@echo "ðŸ“Š System monitoring..."
	@echo "CPU Usage:"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
	@echo ""
	@echo "Disk Usage:"
	@du -sh ./outputs ./uploads ./temp 2>/dev/null || echo "Directories not found"

# Quick commands for common tasks
quick: install up open
	@echo "âš¡ Quick start complete!"

restart: down up
	@echo "ðŸ”„ Services restarted!"

update: down build up
	@echo "ðŸ”„ System updated!"
