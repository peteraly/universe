{% extends "base.html" %}

{% block title %}Simulation - Research Analyst{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-0">
                    <i class="bi bi-play-circle text-warning"></i>
                    Research Simulation Panel
                </h1>
                <p class="text-muted">Interactive task simulation with AI assistance and real-time editing.</p>
            </div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                <i class="bi bi-plus-circle"></i> New Task
            </button>
        </div>
    </div>

    <!-- New Task Modal -->
    <div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="newTaskModalLabel">Create New Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="newTaskForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Title *</label>
                  <input type="text" class="form-control" name="title" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Category</label>
                  <select class="form-select" name="category">
                    <option>Corporate Strategy</option>
                    <option>Research Support</option>
                    <option>Content Curation</option>
                    <option>Communications</option>
                  </select>
                </div>
                <div class="col-md-12">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" name="description" rows="2"></textarea>
                </div>
                <div class="col-md-12">
                  <label class="form-label">Deliverable Request/Description</label>
                  <input type="text" class="form-control" name="deliverable">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Deliverable Type</label>
                  <select class="form-select" name="deliverable_type">
                    <option>Executive Brief</option>
                    <option>SWOT Analysis</option>
                    <option>Market Map</option>
                    <option>Policy Memo</option>
                    <option>Slide Deck</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Format</label>
                  <input type="text" class="form-control" name="format" placeholder="e.g. Table + Narrative, Infographic">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Sections (comma-separated)</label>
                  <input type="text" class="form-control" name="sections">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Objectives (one per line)</label>
                  <textarea class="form-control" name="objectives" rows="2"></textarea>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Stakeholders (comma-separated)</label>
                  <input type="text" class="form-control" name="stakeholders">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Due Date</label>
                  <input type="date" class="form-control" name="due_date">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Tags (comma-separated)</label>
                  <input type="text" class="form-control" name="tags">
                </div>
                <div class="col-md-12">
                  <label class="form-label">Instructions (optional)</label>
                  <textarea class="form-control" name="instructions" rows="2"></textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success" onclick="submitNewTask()">Create Task</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Simulation Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear"></i>
                        Simulation Controls
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Simulation Speed</label>
                            <select class="form-select" id="simulationSpeed">
                                <option value="1">1x (Real-time)</option>
                                <option value="2">2x (Fast)</option>
                                <option value="5">5x (Very Fast)</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">AI Assistance Level</label>
                            <select class="form-select" id="aiLevel">
                                <option value="full">Full AI Support</option>
                                <option value="partial">Partial AI Support</option>
                                <option value="minimal">Minimal AI Support</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Auto-generate Deliverables</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoGenerate" checked>
                                <label class="form-check-label" for="autoGenerate">Enable</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-primary w-100" onclick="startSimulation()">
                                <i class="bi bi-play-fill"></i>
                                Start Simulation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Suggested Sources Panel -->
    <div class="row mb-4" id="suggestedSourcesRow" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightbulb"></i>
                        Suggested Sources for <span id="selectedTaskTitle">Selected Task</span>
                        <span class="badge badge-warning ms-2" id="sourceCount">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="suggestedSourcesList">
                        <!-- Sources will be populated here -->
                    </div>
                    <div class="text-center text-muted py-3" id="noSourcesMessage">
                        <i class="bi bi-inbox display-4"></i>
                        <p class="mt-2">No sources matched for this task</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Simulation Grid -->
    <div class="row">
        {% for task in tasks %}
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="task-simulation-card" data-task-id="{{ task.id }}" onclick="selectTask('{{ task.id }}', '{{ task.title }}')">
                <!-- Confidence Indicators -->
                <div class="confidence-indicators">
                    <div class="quality-score" data-score="{{ task.get('quality_score', 75) }}">
                        <div class="score-ring">
                            <svg width="40" height="40" viewBox="0 0 40 40">
                                <circle cx="20" cy="20" r="18" fill="none" stroke="var(--bg-tertiary)" stroke-width="3"/>
                                <circle cx="20" cy="20" r="18" fill="none" stroke="var(--quality-color)" stroke-width="3" 
                                        stroke-dasharray="{{ (task.get('quality_score', 75) / 100) * 113 }}" stroke-dashoffset="0" 
                                        transform="rotate(-90 20 20)"/>
                            </svg>
                            <span class="score-text">{{ task.get('quality_score', 75) }}</span>
                        </div>
                        <span class="score-label">Quality</span>
                    </div>
                    
                    <div class="risk-urgency-indicators">
                        <div class="risk-indicator risk-{{ task.get('context', {}).get('risk_level', 'Medium').lower() }}">
                            <i class="bi bi-exclamation-triangle"></i>
                            <span>{{ task.get('context', {}).get('risk_level', 'Medium') }}</span>
                        </div>
                        <div class="urgency-indicator urgency-{{ task.get('context', {}).get('urgency', 'Medium').lower() }}">
                            <i class="bi bi-clock"></i>
                            <span>{{ task.get('context', {}).get('urgency', 'Medium') }}</span>
                        </div>
                    </div>
                </div>

                <div class="task-header">
                    <div class="task-title">
                        <h6 class="mb-1">{{ task.title }}</h6>
                        <span class="badge badge-{{ 'success' if task.status == 'Completed' else 'warning' if task.status == 'In Progress' else 'info' }}">
                            {{ task.status }}
                        </span>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editTask('{{ task.id }}'); event.stopPropagation();">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="generateDeliverable('{{ task.id }}'); event.stopPropagation();">
                            <i class="bi bi-robot"></i>
                        </button>
                        <a href="{{ url_for('edit_deliverable', task_id=task.id) }}" class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation();">
                            <i class="bi bi-file-text"></i>
                        </a>
                    </div>
                </div>

                <div class="task-content">
                    <div class="task-description">
                        <p class="small text-muted">{{ task.description or 'No description available' }}</p>
                    </div>

                    <!-- Objectives Section -->
                    {% if task.get('objectives') %}
                    <div class="task-objectives">
                        <h6 class="small mb-2">Objectives</h6>
                        <div class="objectives-list">
                            {% for objective in task.get('objectives', [])[:3] %}
                                <div class="objective-item">
                                    <i class="bi bi-check2-circle text-success"></i>
                                    <span class="small">{{ objective }}</span>
                                </div>
                            {% endfor %}
                            {% if task.get('objectives', [])|length > 3 %}
                                <div class="objective-more">
                                    <span class="small text-muted">+{{ task.get('objectives', [])|length - 3 }} more</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="task-meta">
                        <div class="meta-item">
                            <i class="bi bi-tag"></i>
                            <span>{{ task.category }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-calendar"></i>
                            <span>{{ task.due_date or 'No due date' }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-people"></i>
                            <span>{{ task.stakeholders|length }} stakeholders</span>
                        </div>
                        {% if task.get('context', {}).get('estimated_effort') %}
                        <div class="meta-item">
                            <i class="bi bi-hourglass-split"></i>
                            <span>{{ task.get('context', {}).get('estimated_effort') }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="task-progress">
                        <div class="progress-info">
                            <span>Progress</span>
                            <span>{{ task.progress }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ task.progress }}%"></div>
                        </div>
                    </div>

                    <div class="task-sources">
                        <h6 class="small mb-2">Research Sources</h6>
                        <div class="source-tags">
                            {% for source in task.sources %}
                                <span class="badge badge-info">{{ source }}</span>
                            {% endfor %}
                            {% if not task.sources %}
                                <span class="text-muted small">No sources assigned</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="task-deliverable">
                        <h6 class="small mb-2">Deliverable</h6>
                        <div class="deliverable-info">
                            {% if task.deliverable %}
                                <span class="badge badge-success">{{ task.deliverable }}</span>
                            {% else %}
                                <span class="text-muted small">No deliverable yet</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="task-ai-controls">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="aiAssist{{ task.id }}" checked>
                            <label class="form-check-label small" for="aiAssist{{ task.id }}">
                                AI Assistance
                            </label>
                        </div>
                        <div class="ai-status" id="aiStatus{{ task.id }}">
                            <span class="badge badge-success">AI Active</span>
                        </div>
                    </div>
                </div>

                <div class="task-footer">
                    <button class="btn btn-sm btn-outline-primary" onclick="simulateWork('{{ task.id }}'); event.stopPropagation();">
                        <i class="bi bi-play"></i>
                        Simulate Work
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="addSource('{{ task.id }}'); event.stopPropagation();">
                        <i class="bi bi-plus"></i>
                        Add Source
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewDetails('{{ task.id }}'); event.stopPropagation();">
                        <i class="bi bi-eye"></i>
                        Details
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Simulation Results -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i>
                        Simulation Results
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="result-card">
                                <div class="result-icon">
                                    <i class="bi bi-clock text-info"></i>
                                </div>
                                <div class="result-content">
                                    <h4 id="totalTime">0h 0m</h4>
                                    <p>Total Simulation Time</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="result-card">
                                <div class="result-icon">
                                    <i class="bi bi-check-circle text-success"></i>
                                </div>
                                <div class="result-content">
                                    <h4 id="completedTasks">0</h4>
                                    <p>Tasks Completed</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="result-card">
                                <div class="result-icon">
                                    <i class="bi bi-robot text-warning"></i>
                                </div>
                                <div class="result-content">
                                    <h4 id="aiGenerations">0</h4>
                                    <p>AI Generations</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="result-card">
                                <div class="result-icon">
                                    <i class="bi bi-speedometer2 text-primary"></i>
                                </div>
                                <div class="result-content">
                                    <h4 id="efficiency">0%</h4>
                                    <p>Efficiency Score</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.task-simulation-card {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
}

.task-simulation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    border-color: var(--visa-gold);
}

/* Confidence Indicators */
.confidence-indicators {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
    z-index: 10;
}

.quality-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
}

.score-ring {
    position: relative;
    width: 40px;
    height: 40px;
}

.score-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-primary);
}

.score-label {
    font-size: 0.625rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.risk-urgency-indicators {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.risk-indicator, .urgency-indicator {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.risk-low {
    background-color: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.risk-medium {
    background-color: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.risk-high {
    background-color: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}

.risk-critical {
    background-color: rgba(220, 53, 69, 0.3);
    color: #dc3545;
    animation: pulse 2s infinite;
}

.urgency-low {
    background-color: rgba(108, 117, 125, 0.2);
    color: #6c757d;
}

.urgency-medium {
    background-color: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.urgency-high {
    background-color: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}

.urgency-critical {
    background-color: rgba(220, 53, 69, 0.3);
    color: #dc3545;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Quality Score Colors */
.quality-score[data-score="90"] .score-ring circle:last-child { stroke: #28a745; }
.quality-score[data-score="85"] .score-ring circle:last-child { stroke: #28a745; }
.quality-score[data-score="80"] .score-ring circle:last-child { stroke: #28a745; }
.quality-score[data-score="75"] .score-ring circle:last-child { stroke: #ffc107; }
.quality-score[data-score="70"] .score-ring circle:last-child { stroke: #ffc107; }
.quality-score[data-score="65"] .score-ring circle:last-child { stroke: #ffc107; }
.quality-score[data-score="60"] .score-ring circle:last-child { stroke: #fd7e14; }
.quality-score[data-score="55"] .score-ring circle:last-child { stroke: #fd7e14; }
.quality-score[data-score="50"] .score-ring circle:last-child { stroke: #fd7e14; }
.quality-score[data-score="45"] .score-ring circle:last-child { stroke: #dc3545; }
.quality-score[data-score="40"] .score-ring circle:last-child { stroke: #dc3545; }
.quality-score[data-score="35"] .score-ring circle:last-child { stroke: #dc3545; }
.quality-score[data-score="30"] .score-ring circle:last-child { stroke: #dc3545; }
.quality-score[data-score="25"] .score-ring circle:last-child { stroke: #dc3545; }
.quality-score[data-score="20"] .score-ring circle:last-child { stroke: #dc3545; }
.quality-score[data-score="15"] .score-ring circle:last-child { stroke: #dc3545; }
.quality-score[data-score="10"] .score-ring circle:last-child { stroke: #dc3545; }
.quality-score[data-score="5"] .score-ring circle:last-child { stroke: #dc3545; }
.quality-score[data-score="0"] .score-ring circle:last-child { stroke: #dc3545; }

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-right: 3rem; /* Make room for confidence indicators */
}

.task-title h6 {
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.task-actions {
    display: flex;
    gap: 0.5rem;
}

.task-content {
    flex: 1;
}

.task-description {
    margin-bottom: 1rem;
}

/* Objectives Section */
.task-objectives {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background-color: var(--bg-tertiary);
    border-radius: 8px;
    border-left: 3px solid var(--visa-gold);
}

.objectives-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.objective-item {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}

.objective-item i {
    margin-top: 0.125rem;
    flex-shrink: 0;
}

.objective-more {
    text-align: center;
    padding-top: 0.25rem;
    border-top: 1px solid var(--border-color);
}

.task-meta {
    margin-bottom: 1rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.meta-item i {
    color: var(--visa-gold);
}

.task-progress {
    margin-bottom: 1rem;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.task-sources, .task-deliverable {
    margin-bottom: 1rem;
}

.source-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.task-ai-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background-color: var(--bg-tertiary);
    border-radius: 8px;
}

.task-footer {
    display: flex;
    gap: 0.5rem;
    margin-top: auto;
}

.result-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.result-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.result-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.result-content h4 {
    margin: 0;
    color: var(--text-primary);
    font-weight: 700;
}

.result-content p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

/* Suggested Sources Panel Styles */
.source-item {
    background: var(--bg-secondary);
    border-color: var(--border-color) !important;
    transition: all 0.3s ease;
}

.source-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border-color: var(--visa-gold) !important;
}

.source-media-icon {
    font-size: 1.5rem;
    margin-right: 0.5rem;
}

.source-relevance {
    font-size: 0.75rem;
    font-weight: 600;
}

.source-freshness {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.source-actions {
    display: flex;
    gap: 0.25rem;
}

.source-actions .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    let simulationRunning = false;
    let simulationTimer = null;
    let totalTime = 0;
    let completedTasks = 0;
    let aiGenerations = 0;

    function startSimulation() {
        if (simulationRunning) {
            stopSimulation();
            return;
        }

        simulationRunning = true;
        const speed = parseInt(document.getElementById('simulationSpeed').value);
        const aiLevel = document.getElementById('aiLevel').value;
        const autoGenerate = document.getElementById('autoGenerate').checked;

        // Update button
        event.target.innerHTML = '<i class="bi bi-stop-fill"></i> Stop Simulation';
        event.target.className = 'btn btn-danger w-100';

        // Start timer
        simulationTimer = setInterval(() => {
            totalTime += speed;
            updateResults();
            
            // Simulate random task progress
            simulateRandomProgress();
        }, 1000);

        console.log(`Simulation started with speed: ${speed}x, AI level: ${aiLevel}, Auto-generate: ${autoGenerate}`);
    }

    function stopSimulation() {
        simulationRunning = false;
        clearInterval(simulationTimer);
        
        // Reset button
        event.target.innerHTML = '<i class="bi bi-play-fill"></i> Start Simulation';
        event.target.className = 'btn btn-primary w-100';
        
        console.log('Simulation stopped');
    }

    function simulateRandomProgress() {
        const taskCards = document.querySelectorAll('.task-simulation-card');
        const randomTask = taskCards[Math.floor(Math.random() * taskCards.length)];
        const taskId = randomTask.dataset.taskId;
        
        // Simulate progress increase
        const progressBar = randomTask.querySelector('.progress-bar');
        const currentProgress = parseInt(progressBar.style.width) || 0;
        const newProgress = Math.min(currentProgress + Math.random() * 10, 100);
        
        progressBar.style.width = newProgress + '%';
        randomTask.querySelector('.progress-info span:last-child').textContent = Math.round(newProgress) + '%';
        
        // Update task status if completed
        if (newProgress >= 100) {
            const statusBadge = randomTask.querySelector('.badge');
            statusBadge.textContent = 'Completed';
            statusBadge.className = 'badge badge-success';
            completedTasks++;
        }
        
        // Simulate AI generation
        if (Math.random() > 0.7) {
            aiGenerations++;
            simulateAIGeneration(taskId);
        }
    }

    function simulateAIGeneration(taskId) {
        const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
        const aiStatus = taskCard.querySelector('.ai-status');
        
        // Flash AI status
        aiStatus.innerHTML = '<span class="badge badge-warning">AI Working...</span>';
        
        setTimeout(() => {
            aiStatus.innerHTML = '<span class="badge badge-success">AI Active</span>';
        }, 2000);
    }

    function updateResults() {
        const hours = Math.floor(totalTime / 3600);
        const minutes = Math.floor((totalTime % 3600) / 60);
        
        document.getElementById('totalTime').textContent = `${hours}h ${minutes}m`;
        document.getElementById('completedTasks').textContent = completedTasks;
        document.getElementById('aiGenerations').textContent = aiGenerations;
        
        // Calculate efficiency
        const totalTasks = {{ tasks|length }};
        const efficiency = Math.round((completedTasks / totalTasks) * 100);
        document.getElementById('efficiency').textContent = efficiency + '%';
    }

    function editTask(taskId) {
        console.log('Editing task:', taskId);
        alert('Edit functionality would open a modal for task editing');
    }

    function generateDeliverable(taskId) {
        console.log('Generating deliverable for task:', taskId);
        
        fetch('/api/deliverables/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                task_id: taskId,
                format_type: 'executive_brief'
            })
        })
        .then(response => response.json())
        .then(data => {
            aiGenerations++;
            updateResults();
            
            // Show success message and offer to edit
            if (confirm('Deliverable generated successfully! Would you like to edit it now?')) {
                window.location.href = `/edit/${taskId}`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating deliverable');
        });
    }

    function simulateWork(taskId) {
        const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
        const progressBar = taskCard.querySelector('.progress-bar');
        const currentProgress = parseInt(progressBar.style.width) || 0;
        const newProgress = Math.min(currentProgress + 20, 100);
        
        progressBar.style.width = newProgress + '%';
        taskCard.querySelector('.progress-info span:last-child').textContent = Math.round(newProgress) + '%';
        
        if (newProgress >= 100) {
            const statusBadge = taskCard.querySelector('.badge');
            statusBadge.textContent = 'Completed';
            statusBadge.className = 'badge badge-success';
            completedTasks++;
            updateResults();
        }
    }

    function addSource(taskId) {
        console.log('Adding source to task:', taskId);
        alert('Add source functionality would open a source selection modal');
    }

    function viewDetails(taskId) {
        console.log('Viewing details for task:', taskId);
        alert('Details view would show comprehensive task information and history');
    }

    // Initialize progress bars
    document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('.progress-bar');
        progressBars.forEach(bar => {
            const taskCard = bar.closest('.task-simulation-card');
            const progressText = taskCard.querySelector('.progress-info span:last-child');
            const progress = parseInt(progressText.textContent);
            bar.style.width = progress + '%';
        });
    });

    // Mock data for suggested sources
    const mockSources = {
        'task-001': [
            {
                id: 'source-001',
                title: 'CB Insights - BNPL Market Report Q3 2025',
                media_type: 'article',
                relevance_score: 0.92,
                tags: ['BNPL', 'market analysis', 'fintech'],
                freshness: '2025-01-15T10:30:00Z'
            },
            {
                id: 'source-003',
                title: 'McKinsey - Digital Payments in APAC',
                media_type: 'article',
                relevance_score: 0.95,
                tags: ['APAC', 'digital payments', 'market expansion'],
                freshness: '2025-01-18T09:15:00Z'
            }
        ],
        'task-002': [
            {
                id: 'source-008',
                title: 'Competitor Analysis Database',
                media_type: 'database',
                relevance_score: 0.91,
                tags: ['competitive intelligence', 'internal', 'analysis'],
                freshness: '2025-01-16T12:45:00Z'
            }
        ],
        'task-003': [
            {
                id: 'source-011',
                title: 'European Commission - PSD3 Directive',
                media_type: 'article',
                relevance_score: 0.97,
                tags: ['PSD3', 'regulatory', 'EU', 'compliance'],
                freshness: '2025-01-19T14:30:00Z'
            }
        ]
    };

    function selectTask(taskId, taskTitle) {
        // Remove active class from all tasks
        document.querySelectorAll('.task-simulation-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Add active class to selected task
        const selectedCard = document.querySelector(`[data-task-id="${taskId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('active');
        }
        
        // Show suggested sources
        showSuggestedSources(taskId, taskTitle);
    }

    function showSuggestedSources(taskId, taskTitle) {
        const row = document.getElementById('suggestedSourcesRow');
        const list = document.getElementById('suggestedSourcesList');
        const noMessage = document.getElementById('noSourcesMessage');
        const countBadge = document.getElementById('sourceCount');
        const titleSpan = document.getElementById('selectedTaskTitle');
        
        titleSpan.textContent = taskTitle;
        const sources = mockSources[taskId] || [];
        
        if (sources.length > 0) {
            row.style.display = 'block';
            noMessage.style.display = 'none';
            countBadge.textContent = sources.length;
            
            list.innerHTML = sources.map(source => `
                <div class="source-item mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-${getMediaIcon(source.media_type)} me-2 text-primary"></i>
                            <h6 class="mb-0">${source.title}</h6>
                        </div>
                        <span class="badge badge-success">${Math.round(source.relevance_score * 100)}%</span>
                    </div>
                    <div class="mb-2">
                        ${source.tags.map(tag => `<span class="badge badge-secondary me-1">${tag}</span>`).join('')}
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${formatDate(source.freshness)}</small>
                        <div>
                            <button class="btn btn-sm btn-success me-1" onclick="acceptSource('${source.id}')">
                                <i class="bi bi-check"></i> Accept
                            </button>
                            <button class="btn btn-sm btn-warning me-1" onclick="markCritical('${source.id}')">
                                <i class="bi bi-exclamation-triangle"></i> Critical
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="dismissSource('${source.id}')">
                                <i class="bi bi-x"></i> Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            row.style.display = 'none';
        }
    }

    function getMediaIcon(mediaType) {
        const icons = {
            'article': 'file-text',
            'video': 'play-circle',
            'podcast': 'headphones',
            'database': 'database',
            'webinar': 'camera-video'
        };
        return icons[mediaType] || 'file';
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        return date.toLocaleDateString();
    }

    function acceptSource(sourceId) {
        console.log('Source accepted:', sourceId);
        showNotification('Source accepted and assigned to task', 'success');
    }

    function markCritical(sourceId) {
        console.log('Source marked as critical:', sourceId);
        showNotification('Source marked as critical', 'warning');
    }

    function dismissSource(sourceId) {
        console.log('Source dismissed:', sourceId);
        showNotification('Source suggestion dismissed', 'info');
    }

    function showNotification(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }

    function submitNewTask() {
        const form = document.getElementById('newTaskForm');
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => {
            if (key === 'sections' || key === 'stakeholders' || key === 'tags') {
                data[key] = value.split(',').map(s => s.trim()).filter(Boolean);
            } else if (key === 'objectives') {
                data[key] = value.split('\n').map(s => s.trim()).filter(Boolean);
            } else {
                data[key] = value;
            }
        });
        data['origin'] = 'analyst';
        
        fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(result => {
            if (result && result.success && result.id) {
                // Show success message
                showNotification('Task created successfully!', 'success');
                // Close modal and reload
                var modal = bootstrap.Modal.getInstance(document.getElementById('newTaskModal'));
                modal.hide();
                // Reset form
                form.reset();
                // Reload page to show new task
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error(result.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error creating task:', error);
            showNotification('Error creating task: ' + error.message, 'danger');
        });
    }
</script>
{% endblock %} 