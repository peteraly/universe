{% extends "base.html" %}

{% block title %}Research Sources - Research Analyst{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-0">
                <i class="bi bi-journal-text text-warning"></i>
                Research Sources
            </h1>
            <p class="text-muted">Browse, tag, and integrate external/internal research sources.</p>
        </div>
    </div>

    <!-- Source Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="kpi-card">
                <div class="kpi-value">{{ sources|length }}</div>
                <div class="kpi-label">Total Sources</div>
                <div class="mt-2">
                    <span class="badge badge-success">Available</span>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="kpi-card">
                <div class="kpi-value">{{ sources|selectattr('access_status', 'equalto', 'Available')|list|length }}</div>
                <div class="kpi-label">Available Sources</div>
                <div class="mt-2">
                    <span class="badge badge-success">Active</span>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="kpi-card">
                <div class="kpi-value">{{ sources|selectattr('type', 'equalto', 'Report')|list|length }}</div>
                <div class="kpi-label">Research Reports</div>
                <div class="mt-2">
                    <span class="badge badge-info">Reports</span>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="kpi-card">
                <div class="kpi-value">{{ sources|selectattr('type', 'equalto', 'Database')|list|length }}</div>
                <div class="kpi-label">Databases</div>
                <div class="mt-2">
                    <span class="badge badge-primary">Databases</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel"></i>
                        Filters & Search
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Source Type</label>
                            <select class="form-select" id="sourceTypeFilter">
                                <option value="">All Types</option>
                                <option value="Report">Research Reports</option>
                                <option value="Database">Databases</option>
                                <option value="Article">Articles</option>
                                <option value="News">News</option>
                                <option value="Internal">Internal</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Access Status</label>
                            <select class="form-select" id="accessStatusFilter">
                                <option value="">All Status</option>
                                <option value="Available">Available</option>
                                <option value="Subscription Required">Subscription Required</option>
                                <option value="Restricted">Restricted</option>
                                <option value="Expired">Expired</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Search Sources</label>
                            <input type="text" class="form-control" id="sourceSearch" placeholder="Search by title, description, or tags...">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sources Grid -->
    <div class="row">
        {% for source in sources %}
        <div class="col-lg-6 col-xl-4 mb-4 source-card" 
             data-type="{{ source.type }}" 
             data-status="{{ source.access_status }}"
             data-title="{{ source.title|lower }}"
             data-tags="{{ source.tags|join(' ')|lower }}">
            <div class="card source-item">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">{{ source.title }}</h6>
                    <span class="badge badge-{{ 'success' if source.access_status == 'Available' else 'warning' if source.access_status == 'Subscription Required' else 'danger' }}">
                        {{ source.access_status }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="source-meta mb-3">
                        <div class="meta-item">
                            <i class="bi bi-tag"></i>
                            <span class="badge badge-primary">{{ source.type }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-calendar"></i>
                            <span>{{ source.added_at[:10] }}</span>
                        </div>
                    </div>

                    <div class="source-url mb-3">
                        <a href="{{ source.url }}" target="_blank" class="text-info">
                            <i class="bi bi-link-45deg"></i>
                            {{ source.url[:50] }}...
                        </a>
                    </div>

                    <div class="source-tags mb-3">
                        <h6 class="small mb-2">Tags</h6>
                        <div class="tag-container">
                            {% for tag in source.tags %}
                                <span class="badge badge-info">{{ tag }}</span>
                            {% endfor %}
                            {% if not source.tags %}
                                <span class="text-muted small">No tags</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="source-usage mb-3">
                        <h6 class="small mb-2">Usage Analytics</h6>
                        <div class="usage-stats">
                            <div class="stat-item">
                                <span class="stat-label">Tasks:</span>
                                <span class="stat-value">{{ tasks|selectattr('sources', 'contains', source.title)|list|length }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Last Used:</span>
                                <span class="stat-value">{{ source.added_at[:10] }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="source-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editSource('{{ source.id }}')">
                            <i class="bi bi-pencil"></i>
                            Edit
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="addTags('{{ source.id }}')">
                            <i class="bi bi-tags"></i>
                            Tag
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewSource('{{ source.id }}')">
                            <i class="bi bi-eye"></i>
                            View
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="assignToTask('{{ source.id }}')">
                            <i class="bi bi-link"></i>
                            Assign
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Add New Source -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-plus-circle"></i>
                        Add New Source
                    </h5>
                </div>
                <div class="card-body">
                    <form id="addSourceForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Source Title</label>
                                <input type="text" class="form-control" id="sourceTitle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Source Type</label>
                                <select class="form-select" id="sourceType" required>
                                    <option value="">Select Type</option>
                                    <option value="Report">Research Report</option>
                                    <option value="Database">Database</option>
                                    <option value="Article">Article</option>
                                    <option value="News">News</option>
                                    <option value="Internal">Internal</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">URL</label>
                                <input type="url" class="form-control" id="sourceUrl" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Access Status</label>
                                <select class="form-select" id="sourceAccessStatus" required>
                                    <option value="Available">Available</option>
                                    <option value="Subscription Required">Subscription Required</option>
                                    <option value="Restricted">Restricted</option>
                                    <option value="Expired">Expired</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Tags (comma-separated)</label>
                                <input type="text" class="form-control" id="sourceTags" placeholder="e.g., fintech, payments, market analysis">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i>
                                    Add Source
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Source Analytics -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i>
                        Source Analytics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6>Most Used Sources</h6>
                            <div class="usage-chart">
                                {% for source in sources[:5] %}
                                <div class="usage-item">
                                    <div class="usage-label">{{ source.title[:30] }}...</div>
                                    <div class="usage-bar">
                                        <div class="usage-fill" style="width: {{ (tasks|selectattr('sources', 'contains', source.title)|list|length / tasks|length * 100) if tasks|length > 0 else 0 }}%"></div>
                                    </div>
                                    <div class="usage-value">{{ tasks|selectattr('sources', 'contains', source.title)|list|length }}</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6>Source Types Distribution</h6>
                            <div class="type-distribution">
                                {% set type_counts = {} %}
                                {% for source in sources %}
                                    {% set _ = type_counts.update({source.type: type_counts.get(source.type, 0) + 1}) %}
                                {% endfor %}
                                {% for type_name, count in type_counts.items() %}
                                <div class="type-item">
                                    <span class="type-name">{{ type_name }}</span>
                                    <span class="type-count">{{ count }}</span>
                                    <div class="type-bar">
                                        <div class="type-fill" style="width: {{ (count / sources|length * 100) if sources|length > 0 else 0 }}%"></div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.source-item {
    transition: all 0.3s ease;
    height: 100%;
}

.source-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.source-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.meta-item i {
    color: var(--visa-gold);
}

.source-url a {
    text-decoration: none;
    word-break: break-all;
}

.tag-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.source-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.usage-stats {
    display: flex;
    justify-content: space-between;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.stat-value {
    font-weight: 600;
    color: var(--text-primary);
}

.usage-chart, .type-distribution {
    margin-top: 1rem;
}

.usage-item, .type-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
}

.usage-label, .type-name {
    flex: 1;
    font-size: 0.875rem;
    color: var(--text-primary);
}

.usage-bar, .type-bar {
    flex: 2;
    height: 8px;
    background-color: var(--bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
}

.usage-fill, .type-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--visa-gold), var(--visa-gold-light));
    border-radius: 4px;
    transition: width 0.3s ease;
}

.usage-value, .type-count {
    min-width: 30px;
    text-align: right;
    font-weight: 600;
    color: var(--text-primary);
}

.source-card.hidden {
    display: none;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // Filter functionality
    function filterSources() {
        const typeFilter = document.getElementById('sourceTypeFilter').value;
        const statusFilter = document.getElementById('accessStatusFilter').value;
        const searchQuery = document.getElementById('sourceSearch').value.toLowerCase();
        
        const sourceCards = document.querySelectorAll('.source-card');
        
        sourceCards.forEach(card => {
            const type = card.dataset.type;
            const status = card.dataset.status;
            const title = card.dataset.title;
            const tags = card.dataset.tags;
            
            const typeMatch = !typeFilter || type === typeFilter;
            const statusMatch = !statusFilter || status === statusFilter;
            const searchMatch = !searchQuery || title.includes(searchQuery) || tags.includes(searchQuery);
            
            if (typeMatch && statusMatch && searchMatch) {
                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        });
    }

    // Add event listeners for filters
    document.getElementById('sourceTypeFilter').addEventListener('change', filterSources);
    document.getElementById('accessStatusFilter').addEventListener('change', filterSources);
    document.getElementById('sourceSearch').addEventListener('input', filterSources);

    // Add new source functionality
    document.getElementById('addSourceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            title: document.getElementById('sourceTitle').value,
            type: document.getElementById('sourceType').value,
            url: document.getElementById('sourceUrl').value,
            access_status: document.getElementById('sourceAccessStatus').value,
            tags: document.getElementById('sourceTags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
        };
        
        fetch('/api/sources', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            alert('Source added successfully!');
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding source');
        });
    });

    // Source action functions
    function editSource(sourceId) {
        console.log('Editing source:', sourceId);
        alert('Edit functionality would open a modal for source editing');
    }

    function addTags(sourceId) {
        const tags = prompt('Enter tags (comma-separated):');
        if (tags) {
            const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            fetch('/api/tag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'source',
                    item_id: sourceId,
                    tags: tagArray
                })
            })
            .then(response => response.json())
            .then(data => {
                alert('Tags updated successfully!');
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating tags');
            });
        }
    }

    function viewSource(sourceId) {
        console.log('Viewing source:', sourceId);
        alert('View functionality would show detailed source information');
    }

    function assignToTask(sourceId) {
        console.log('Assigning source to task:', sourceId);
        alert('Assign functionality would open a task selection modal');
    }

    // Initialize filters
    document.addEventListener('DOMContentLoaded', function() {
        filterSources();
    });
</script>
{% endblock %} 