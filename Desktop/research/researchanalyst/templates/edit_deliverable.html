{% extends "base.html" %}

{% block title %}Edit Deliverable - {{ task.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">
                        <i class="bi bi-pencil-square text-warning"></i>
                        Edit Deliverable
                    </h1>
                    <p class="text-muted">{{ task.title }}</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="saveDraft()">
                        <i class="bi bi-save"></i> Save Draft
                    </button>
                    <button class="btn btn-primary" onclick="generateDeliverable()">
                        <i class="bi bi-robot"></i> Generate
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportDeliverable('pdf')">PDF</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportDeliverable('docx')">Word Document</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportDeliverable('html')">HTML</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportDeliverable('pptx')">PowerPoint</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Editor Panel -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-file-text"></i>
                            Deliverable Content
                        </h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="formatType" onchange="changeFormat()">
                                <option value="executive_brief">Executive Brief</option>
                                <option value="market_analysis">Market Analysis</option>
                                <option value="regulatory_roadmap">Regulatory Roadmap</option>
                                <option value="slide_deck">Presentation Deck</option>
                                <option value="policy_memo">Policy Memo</option>
                            </select>
                            <button class="btn btn-sm btn-outline-secondary" onclick="togglePreview()">
                                <i class="bi bi-eye"></i> Preview
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Format Detection Info -->
                    <div class="alert alert-info mb-3" id="formatInfo">
                        <i class="bi bi-lightbulb"></i>
                        <strong>Format Detected:</strong> 
                        <span id="detectedFormat">Executive Brief</span> - 
                        <span id="formatDescription">2-3 page concise analysis for senior leadership</span>
                    </div>

                    <!-- Editor Tabs -->
                    <ul class="nav nav-tabs" id="editorTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="editor-tab" data-bs-toggle="tab" data-bs-target="#editor" type="button" role="tab">
                                <i class="bi bi-pencil"></i> Editor
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab">
                                <i class="bi bi-eye"></i> Preview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure" type="button" role="tab">
                                <i class="bi bi-diagram-3"></i> Structure
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content mt-3" id="editorTabContent">
                        <!-- Editor Tab -->
                        <div class="tab-pane fade show active" id="editor" role="tabpanel">
                            <div class="editor-toolbar mb-3">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')">
                                        <i class="bi bi-type-underline"></i>
                                    </button>
                                </div>
                                <div class="btn-group ms-2" role="group">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="insertHeading(1)">H1</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="insertHeading(2)">H2</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="insertHeading(3)">H3</button>
                                </div>
                                <div class="btn-group ms-2" role="group">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="insertList('ul')">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="insertList('ol')">
                                        <i class="bi bi-list-ol"></i>
                                    </button>
                                </div>
                                <div class="btn-group ms-2" role="group">
                                    <button class="btn btn-sm btn-outline-warning" onclick="insertCitation()">
                                        <i class="bi bi-quote"></i> Citation
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="insertSourceQuote()">
                                        <i class="bi bi-quote"></i> Quote
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <textarea class="form-control" id="deliverableContent" rows="20" placeholder="Start writing your deliverable content here...">{{ deliverable_content|default('') }}</textarea>
                            </div>
                        </div>

                        <!-- Preview Tab -->
                        <div class="tab-pane fade" id="preview" role="tabpanel">
                            <div class="preview-content" id="previewContent">
                                <!-- Preview content will be rendered here -->
                            </div>
                        </div>

                        <!-- Structure Tab -->
                        <div class="tab-pane fade" id="structure" role="tabpanel">
                            <div class="structure-outline" id="structureOutline">
                                <!-- Document structure will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Source Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-journal-text"></i>
                        Sources & Citations
                        <span class="badge badge-primary ms-2" id="sourceCount">{{ sources|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Source Search -->
                    <div class="mb-3">
                        <input type="text" class="form-control" id="sourceSearch" placeholder="Search sources..." onkeyup="filterSources()">
                    </div>

                    <!-- Source List -->
                    <div class="source-list" id="sourceList">
                        {% for source in sources %}
                        <div class="source-item mb-3 p-3 border rounded" data-source-id="{{ source.id }}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-{{ 'file-text' if source.media_type == 'article' else 'play-circle' if source.media_type == 'video' else 'headphones' if source.media_type == 'podcast' else 'database' }} me-2 text-primary"></i>
                                    <h6 class="mb-0">{{ source.title }}</h6>
                                </div>
                                <span class="badge badge-success">{{ source.relevance_score|round(2) }}</span>
                            </div>
                            <div class="mb-2">
                                {% for tag in source.tags %}
                                <span class="badge badge-secondary me-1">{{ tag }}</span>
                                {% endfor %}
                            </div>
                            <div class="source-actions">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewSource('{{ source.id }}')">
                                    <i class="bi bi-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="insertSourceCitation('{{ source.id }}')">
                                    <i class="bi bi-quote"></i> Cite
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="insertSourceSnippet('{{ source.id }}')">
                                    <i class="bi bi-text-quote"></i> Quote
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- AI Assistant Panel -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-robot"></i>
                        AI Assistant
                    </h5>
                </div>
                <div class="card-body">
                    <div class="ai-suggestions" id="aiSuggestions">
                        <div class="suggestion-item mb-2">
                            <button class="btn btn-sm btn-outline-primary w-100 text-start" onclick="aiAction('improve')">
                                <i class="bi bi-magic"></i> Improve writing
                            </button>
                        </div>
                        <div class="suggestion-item mb-2">
                            <button class="btn btn-sm btn-outline-warning w-100 text-start" onclick="aiAction('summarize')">
                                <i class="bi bi-file-text"></i> Summarize section
                            </button>
                        </div>
                        <div class="suggestion-item mb-2">
                            <button class="btn btn-sm btn-outline-info w-100 text-start" onclick="aiAction('expand')">
                                <i class="bi bi-arrows-expand"></i> Expand on topic
                            </button>
                        </div>
                        <div class="suggestion-item mb-2">
                            <button class="btn btn-sm btn-outline-success w-100 text-start" onclick="aiAction('structure')">
                                <i class="bi bi-diagram-3"></i> Improve structure
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.editor-toolbar {
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.5rem;
    background-color: var(--bg-secondary);
}

.source-item {
    background: var(--bg-secondary);
    border-color: var(--border-color) !important;
    transition: all 0.3s ease;
}

.source-item:hover {
    background: var(--bg-tertiary);
    transform: translateY(-1px);
}

.preview-content {
    background: white;
    color: black;
    padding: 2rem;
    border-radius: 6px;
    min-height: 400px;
}

.structure-outline {
    background: var(--bg-secondary);
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid var(--border-color);
}

.suggestion-item button:hover {
    background-color: var(--visa-gold);
    border-color: var(--visa-gold);
    color: var(--visa-blue);
}

#deliverableContent {
    background-color: var(--bg-secondary);
    border-color: var(--border-color);
    color: var(--text-primary);
    font-family: 'Inter', sans-serif;
    line-height: 1.6;
}

#deliverableContent:focus {
    background-color: var(--bg-tertiary);
    border-color: var(--visa-gold);
    box-shadow: 0 0 0 0.2rem rgba(247, 182, 0, 0.25);
}
</style>
{% endblock %}

{% block scripts %}
<script>
    let currentTaskId = '{{ task.id }}';
    let currentDeliverable = {{ deliverable|tojson }};
    let sources = {{ sources|tojson }};

    // Initialize editor
    document.addEventListener('DOMContentLoaded', function() {
        initializeEditor();
        updateFormatInfo();
        generateStructureOutline();
    });

    function initializeEditor() {
        // Set initial format type
        const detectedFormat = '{{ detected_format }}';
        if (detectedFormat) {
            document.getElementById('formatType').value = detectedFormat;
        }
        
        // Load existing content if available
        if (currentDeliverable && currentDeliverable.content) {
            document.getElementById('deliverableContent').value = currentDeliverable.content;
        }
    }

    function updateFormatInfo() {
        const formatType = document.getElementById('formatType').value;
        const formatInfo = {
            'executive_brief': { name: 'Executive Brief', desc: '2-3 page concise analysis for senior leadership' },
            'market_analysis': { name: 'Market Analysis', desc: 'Comprehensive market research with data visualization' },
            'regulatory_roadmap': { name: 'Regulatory Roadmap', desc: 'Compliance timeline and impact analysis' },
            'slide_deck': { name: 'Presentation Deck', desc: 'PowerPoint-style presentation for stakeholder meetings' },
            'policy_memo': { name: 'Policy Memo', desc: 'Internal policy recommendation document' }
        };
        
        const info = formatInfo[formatType];
        document.getElementById('detectedFormat').textContent = info.name;
        document.getElementById('formatDescription').textContent = info.desc;
    }

    function changeFormat() {
        updateFormatInfo();
        // Could trigger content regeneration based on new format
    }

    function togglePreview() {
        const previewTab = document.getElementById('preview-tab');
        const preview = new bootstrap.Tab(previewTab);
        preview.show();
        updatePreview();
    }

    function updatePreview() {
        const content = document.getElementById('deliverableContent').value;
        const previewContent = document.getElementById('previewContent');
        
        // Simple markdown to HTML conversion (in production, use a proper library)
        let htmlContent = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/\n/g, '<br>');
        
        previewContent.innerHTML = htmlContent;
    }

    function generateStructureOutline() {
        const content = document.getElementById('deliverableContent').value;
        const outline = document.getElementById('structureOutline');
        
        const lines = content.split('\n');
        let structure = '<h6>Document Structure:</h6><ul>';
        
        lines.forEach(line => {
            if (line.startsWith('# ')) {
                structure += `<li><strong>${line.substring(2)}</strong></li>`;
            } else if (line.startsWith('## ')) {
                structure += `<li style="margin-left: 1rem;">${line.substring(3)}</li>`;
            } else if (line.startsWith('### ')) {
                structure += `<li style="margin-left: 2rem;"><em>${line.substring(4)}</em></li>`;
            }
        });
        
        structure += '</ul>';
        outline.innerHTML = structure;
    }

    // Editor formatting functions
    function formatText(command) {
        document.execCommand(command, false, null);
    }

    function insertHeading(level) {
        const textarea = document.getElementById('deliverableContent');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        const heading = '#'.repeat(level) + ' ' + selectedText;
        textarea.value = textarea.value.substring(0, start) + heading + textarea.value.substring(end);
    }

    function insertList(type) {
        const textarea = document.getElementById('deliverableContent');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        const lines = selectedText.split('\n');
        const listItems = lines.map(line => (type === 'ul' ? '- ' : '1. ') + line).join('\n');
        
        textarea.value = textarea.value.substring(0, start) + listItems + textarea.value.substring(end);
    }

    function insertCitation() {
        const textarea = document.getElementById('deliverableContent');
        const citation = prompt('Enter citation text:');
        if (citation) {
            const insertText = ` (${citation})`;
            const start = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(start);
        }
    }

    function insertSourceQuote() {
        const textarea = document.getElementById('deliverableContent');
        const quote = prompt('Enter quote text:');
        if (quote) {
            const insertText = `\n\n> "${quote}"\n\n`;
            const start = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(start);
        }
    }

    // Source management functions
    function filterSources() {
        const searchTerm = document.getElementById('sourceSearch').value.toLowerCase();
        const sourceItems = document.querySelectorAll('.source-item');
        
        sourceItems.forEach(item => {
            const title = item.querySelector('h6').textContent.toLowerCase();
            const tags = Array.from(item.querySelectorAll('.badge')).map(badge => badge.textContent.toLowerCase());
            
            const matches = title.includes(searchTerm) || tags.some(tag => tag.includes(searchTerm));
            item.style.display = matches ? 'block' : 'none';
        });
    }

    function viewSource(sourceId) {
        const source = sources.find(s => s.id === sourceId);
        if (source) {
            alert(`Viewing source: ${source.title}\n\nURL: ${source.url}\n\nContent preview: ${source.content ? source.content.substring(0, 200) + '...' : 'No content available'}`);
        }
    }

    function insertSourceCitation(sourceId) {
        const source = sources.find(s => s.id === sourceId);
        if (source) {
            const citation = `(${source.title.split(' - ')[0]}, ${new Date(source.freshness).getFullYear()})`;
            const textarea = document.getElementById('deliverableContent');
            const start = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, start) + citation + textarea.value.substring(start);
        }
    }

    function insertSourceSnippet(sourceId) {
        const source = sources.find(s => s.id === sourceId);
        if (source) {
            const snippet = source.content ? source.content.substring(0, 150) + '...' : 'Content not available';
            const quote = `\n\n> "${snippet}"\n> \n> â€” ${source.title}\n\n`;
            const textarea = document.getElementById('deliverableContent');
            const start = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, start) + quote + textarea.value.substring(start);
        }
    }

    // AI Assistant functions
    function aiAction(action) {
        const textarea = document.getElementById('deliverableContent');
        const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
        
        if (!selectedText && action !== 'structure') {
            alert('Please select some text first.');
            return;
        }
        
        // Mock AI actions
        const actions = {
            'improve': 'Improving writing style and clarity...',
            'summarize': 'Generating summary of selected text...',
            'expand': 'Expanding on the selected topic...',
            'structure': 'Analyzing and improving document structure...'
        };
        
        alert(actions[action] + '\n\nThis would integrate with an AI service in production.');
    }

    // Save and export functions
    function saveDraft() {
        const content = document.getElementById('deliverableContent').value;
        
        fetch(`/api/deliverables/${currentTaskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: content,
                status: 'Draft'
            })
        })
        .then(response => response.json())
        .then(data => {
            showNotification('Draft saved successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error saving draft', 'error');
        });
    }

    function generateDeliverable() {
        const formatType = document.getElementById('formatType').value;
        
        fetch('/api/deliverables/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                task_id: currentTaskId,
                format_type: formatType
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('deliverableContent').value = data.content;
            showNotification('Deliverable generated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error generating deliverable', 'error');
        });
    }

    function exportDeliverable(format) {
        const content = document.getElementById('deliverableContent').value;
        
        fetch('/api/deliverables/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                task_id: currentTaskId,
                content: content,
                format: format
            })
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `deliverable-${currentTaskId}.${format}`;
            a.click();
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error exporting deliverable', 'error');
        });
    }

    function showNotification(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }

    // Auto-save functionality
    let autoSaveTimer;
    document.getElementById('deliverableContent').addEventListener('input', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            saveDraft();
        }, 5000); // Auto-save after 5 seconds of inactivity
    });
</script>
{% endblock %} 